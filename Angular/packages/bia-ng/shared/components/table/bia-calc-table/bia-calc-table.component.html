@if (configuration) {
  <form [formGroup]="form" class="bia-calc-form">
    <p-table
      #dt
      [reorderableColumns]="reorderableColumns"
      [resizableColumns]="isResizableColumn"
      [columnResizeMode]="'expand'"
      [columns]="displayedColumns"
      [value]="elements"
      [paginator]="!virtualScroll && paginator"
      [rows]="virtualScroll ? virtualScrollPageSize : pageSize"
      (onFilter)="onFilter()"
      [totalRecords]="totalRecord"
      [lazy]="true"
      [loading]="loading && (showLoading$ | async) !== null"
      (onLazyLoad)="onLoadLazy($event)"
      [stateStorage]="'session'"
      [stateKey]="tableStateKey"
      [lazyLoadOnInit]="getLazyLoadOnInit()"
      [sortField]="sortFieldValue"
      [sortOrder]="sortOrderValue"
      (onStateSave)="onStateSave($event)"
      (selectionChange)="onSelectionChange()"
      stripedRows
      [sortMode]="sortMode"
      [multiSortMeta]="multiSortMeta"
      [scrollHeight]="scrollHeightValue"
      [scrollable]="isScrollable"
      editMode="row"
      dataKey="id"
      [(selection)]="selectedElements"
      [virtualScroll]="virtualScroll"
      [virtualScrollItemSize]="rowHeight"
      dataKey="id"
      [expandedRowKeys]="expandedRows"
      (onRowExpand)="onRowExpand($event)"
      (onRowCollapse)="onRowCollapse($event)"
      (onPage)="pageChange.emit($event)">
      <ng-template pTemplate="header" let-columns>
        <tr>
          @if (canSelectElement === true && !readOnly) {
            <th
              class="bia-table-select-col"
              [style.width]="widthSelect"
              [alignFrozen]="alignFrozenSelect"
              biaFrozenColumn
              [frozen]="isSelectFrozen">
              @if (canSelectMultipleElement) {
                <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
              }
            </th>
          }
          @if (canExpandRow) {
            <th
              [style.width]="widthExpand"
              [alignFrozen]="alignFrozenSelect"
              biaFrozenColumn
              [frozen]="isSelectFrozen"></th>
          }
          @if (showFixableState) {
            <th
              [style.width]="widthSelect"
              [alignFrozen]="alignFrozenSelect"
              biaFrozenColumn
              [frozen]="isSelectFrozen">
              {{ 'bia.fixed' | translate }}
            </th>
          }
          @for (col of columns; track col) {
            @if (col?.isSortable === true) {
              <th
                [pSortableColumn]="col.field"
                pReorderableColumn
                pResizableColumn
                [style.min-width]="col.minWidth"
                [alignFrozen]="col.alignFrozen"
                biaFrozenColumn
                [frozen]="col.isFrozen"
                pTooltip="{{
                  isResizableColumn && !col?.icon
                    ? (col?.header | translate)
                    : ''
                }}"
                tooltipPosition="top">
                <span class="nowrap">
                  @if (!!col?.icon) {
                    <i
                      class="{{ col?.icon }} bia-column-icon"
                      pTooltip="{{ col?.header | translate }}"
                      tooltipPosition="top"></i>
                  } @else {
                    {{ col?.header | translate }}
                  }
                  <p-sortIcon [field]="col.field"></p-sortIcon>
                </span>
              </th>
            } @else {
              <th
                pReorderableColumn
                pResizableColumn
                [style.min-width]="col.minWidth"
                [alignFrozen]="col.alignFrozen"
                biaFrozenColumn
                [frozen]="col.isFrozen"
                pTooltip="{{
                  isResizableColumn && !col?.icon
                    ? (col?.header | translate)
                    : ''
                }}"
                tooltipPosition="top">
                <span class="nowrap">
                  @if (!!col?.icon) {
                    <i
                      class="{{ col?.icon }} bia-column-icon"
                      pTooltip="{{ col?.header | translate }}"
                      tooltipPosition="top"></i>
                  } @else {
                    {{ col?.header | translate }}
                  }
                </span>
              </th>
            }
          }
        </tr>
        @if (showColSearch === true) {
          <tr class="searchTR">
            @if (canSelectElement === true && !readOnly) {
              <th
                [style.width]="widthSelect"
                [alignFrozen]="alignFrozenSelect"
                biaFrozenColumn
                [frozen]="isSelectFrozen"></th>
            }
            @if (canExpandRow) {
              <th
                [style.width]="widthExpand"
                [alignFrozen]="alignFrozenSelect"
                biaFrozenColumn
                pResizableColumn
                [frozen]="isSelectFrozen"></th>
            }
            @if (showFixableState) {
              <th
                [style.width]="widthSelect"
                [alignFrozen]="alignFrozenSelect"
                biaFrozenColumn
                pResizableColumn
                [frozen]="isSelectFrozen"></th>
            }
            @for (col of columns; track col) {
              <th
                pReorderableColumn
                pResizableColumn
                [style.min-width]="col.minWidth"
                [alignFrozen]="col.alignFrozen"
                biaFrozenColumn
                [frozen]="col.isFrozen">
                <bia-table-filter
                  [field]="col"
                  [table]="dt"
                  [options]="getOptionDto(col.field)">
                </bia-table-filter>
              </th>
            }
          </tr>
        }
      </ng-template>
      <ng-template
        pTemplate="body"
        let-rowData
        let-columns="columns"
        let-editing="editing"
        let-ri="rowIndex"
        let-expanded="expanded">
        <!-- SELECTABLE IF NOT FOOTER -->
        <tr
          class="bia-selectable-row"
          [ngClass]="{ 'p-even-row': ri % 2 !== 0 }"
          [pSelectableRow]="rowData?.id !== 0 ? rowData : null"
          [pEditableRow]="rowData"
          (focusout)="onFocusout()"
          (keyup.enter)="initEditableRow(null)"
          (keyup.escape)="escape()">
          <!-- FIRST COLUMN WITH CHECKBOX OR RADIOBUTTON -->
          @if (canSelectElement === true && !readOnly) {
            <td
              [style.width]="widthSelect"
              [alignFrozen]="alignFrozenSelect"
              biaFrozenColumn
              [frozen]="isSelectFrozen">
              <!-- ONLY IF NOT FOOTER -->
              @if (rowData.id !== 0 && rowData.id !== '') {
                @if (canSelectMultipleElement === true) {
                  <p-tableCheckbox [value]="rowData"></p-tableCheckbox>
                } @else {
                  <p-tableRadioButton [value]="rowData"></p-tableRadioButton>
                }
              }
            </td>
          }
          @if (canExpandRow) {
            <td
              [class]="'bia-column-expand'"
              [style.width]="widthExpand"
              [alignFrozen]="alignFrozenSelect"
              biaFrozenColumn
              [frozen]="isSelectFrozen">
              <i
                [pRowToggler]="rowData"
                [class]="
                  expanded ? 'pi pi-angle-down' : 'pi pi-angle-right'
                "></i>
            </td>
          }
          <!-- FIXED STATE COLUMN -->
          @if (showFixableState) {
            <td
              [style.width]="widthSelect"
              [alignFrozen]="alignFrozenSelect"
              biaFrozenColumn
              [frozen]="isSelectFrozen">
              @if (rowData.isFixed === true) {
                <div class="flex justify-content-center">
                  <i class="pi pi-lock"></i>
                </div>
              }
            </td>
          }
          <!-- OTHER COLUMNS -->
          @for (col of columns; track col) {
            <td
              [class]="'bia-column-' + col.typeLowerCase"
              (click)="initEditableRowAndFocus(rowData, $event)"
              [style.min-width]="col.minWidth"
              [alignFrozen]="col.alignFrozen"
              biaFrozenColumn
              [frozen]="col.isFrozen">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  @if (
                    col.isEditable === true &&
                    (col.isOnlyInitializable === false ||
                      col.isOnlyUpdatable === true)
                  ) {
                    <bia-table-input
                      [field]="col"
                      [form]="form"
                      [dictOptionDtos]="dictOptionDtos"
                      (valueChange)="onChange()"
                      (complexInput)="onComplexInput($event)">
                      <ng-template pTemplate="specificInput">
                        <ng-container
                          *ngTemplateOutlet="
                            specificInputTemplate;
                            context: { field: col, form: form }
                          "></ng-container>
                      </ng-template>
                    </bia-table-input>
                  } @else {
                    <!-- ONLY IF NOT FOOTER -->
                    @if (rowData?.id !== 0 && rowData?.id !== '') {
                      <bia-table-output
                        [field]="col"
                        [data]="getCellData(rowData, col)">
                        <ng-template pTemplate="specificOutput">
                          <ng-container
                            *ngTemplateOutlet="
                              specificOutputTemplate;
                              context: {
                                rowData: rowData,
                                field: col,
                                data: getCellData(rowData, col),
                              }
                            "></ng-container>
                        </ng-template>
                      </bia-table-output>
                    }
                  }
                </ng-template>
                <!-- OUTPUT -->
                <ng-template pTemplate="output">
                  <!-- ONLY IF NOT FOOTER -->
                  @if (rowData?.id !== 0 && rowData?.id !== '') {
                    <bia-table-output
                      [field]="col"
                      [data]="getCellData(rowData, col)">
                      <ng-template pTemplate="specificOutput">
                        <ng-container
                          *ngTemplateOutlet="
                            specificOutputTemplate;
                            context: {
                              rowData: rowData,
                              field: col,
                              data: getCellData(rowData, col),
                            }
                          "></ng-container>
                      </ng-template>
                    </bia-table-output>
                  }
                </ng-template>
              </p-cellEditor>
            </td>
          }
        </tr>
      </ng-template>
      @if (canExpandRow) {
        <ng-template pTemplate="expandedrow" let-rowData>
          <tr>
            <td colspan="100%">
              <ng-container
                [ngTemplateOutlet]="expandedRowTemplate"
                [ngTemplateOutletContext]="{ data: rowData }"></ng-container>
            </td>
          </tr>
        </ng-template>
      }
      <ng-template
        pTemplate="loadingbody"
        let-columns="columns"
        let-ri="rowIndex">
        <tr
          [style]="'height: ' + rowHeight + 'px'"
          [ngClass]="{ 'p-even-row': ri % 2 !== 0 }">
          @if (canSelectElement === true && !readOnly) {
            <td
              [style.width]="widthSelect"
              [alignFrozen]="alignFrozenSelect"
              biaFrozenColumn
              [frozen]="isSelectFrozen">
              <p-skeleton
                [ngStyle]="{
                  width: '60%',
                }" />
            </td>
          }
          @for (col of columns; track col; let even = $even) {
            <td>
              <p-skeleton
                [ngStyle]="{
                  width: even ? '40%' : '60%',
                }" />
            </td>
          }
        </tr>
      </ng-template>
      <ng-template pTemplate="footer" let-columns>
        @if (canAdd === true && !readOnly) {
          <tr
            class="bia-selectable-row"
            (focusout)="onFocusout()"
            (keyup.enter)="initEditableRow(null)"
            (keyup.escape)="escape()">
            @if (canSelectElement === true && !readOnly) {
              <td
                (click)="initEditableRow(footerRowData)"
                [style.width]="widthSelect"
                [alignFrozen]="alignFrozenSelect"
                biaFrozenColumn
                [frozen]="isSelectFrozen">
                <i class="pi pi-plus"></i>
              </td>
            }
            @if (canExpandRow) {
              <td
                [class]="'bia-column-expand'"
                [style.width]="widthExpand"
                [alignFrozen]="alignFrozenSelect"
                biaFrozenColumn
                [frozen]="isSelectFrozen"></td>
            }
            @if (showFixableState) {
              <td
                [style.width]="widthSelect"
                [alignFrozen]="alignFrozenSelect"
                biaFrozenColumn
                [frozen]="isSelectFrozen"></td>
            }
            @let firstEditableFieldIndex = firstEditableField(columns);
            @for (col of columns; track col; let i = $index) {
              <td
                (click)="initEditableRow(footerRowData)"
                [style.min-width]="col.minWidth"
                [alignFrozen]="col.alignFrozen"
                biaFrozenColumn
                [frozen]="col.isFrozen">
                <!-- <p-cellEditor> -->
                @if (editFooter === true) {
                  @if (
                    col.isEditable === true &&
                    (col.isOnlyUpdatable === false ||
                      col.isOnlyInitializable === true)
                  ) {
                    <bia-table-input
                      [field]="col"
                      [form]="form"
                      [dictOptionDtos]="dictOptionDtos"
                      [focusByDefault]="i === firstEditableFieldIndex"
                      (valueChange)="onChange()"
                      (complexInput)="onComplexInput($event)">
                      <ng-template pTemplate="specificInput">
                        <ng-container
                          *ngTemplateOutlet="
                            specificInputTemplate;
                            context: { field: col, form: form }
                          "></ng-container>
                      </ng-template>
                    </bia-table-input>
                  } @else {
                    <ng-container>
                      <bia-table-output
                        [field]="col"
                        [data]="getCellData(footerRowData, col)">
                        <ng-template pTemplate="specificOutput">
                          <ng-container
                            *ngTemplateOutlet="
                              specificOutputTemplate;
                              context: {
                                rowData: footerRowData,
                                field: col,
                                data: getCellData(footerRowData, col),
                              }
                            "></ng-container>
                        </ng-template>
                      </bia-table-output>
                    </ng-container>
                  }
                }
                <!-- OUTPUT -->
                @if (editFooter !== true && col.isEditable === true) {
                  <label>-</label>
                }
                <!-- </p-cellEditor> -->
              </td>
            }
          </tr>
        }
      </ng-template>
      <ng-template pTemplate="summary" let-columns>
        @if (virtualScroll) {
          <bia-table-footer-controller
            [length]="totalRecord"
            [pageSize]="pageSize"
            [canChangePageSize]="false"
            (pageSizeChange)="
              onPageSizeValueChange($event)
            "></bia-table-footer-controller>
        }
      </ng-template>
      <ng-template pTemplate="paginatorleft">
        <bia-table-footer-controller
          [length]="totalRecord"
          [pageSize]="pageSize"
          [pageSizeOptions]="pageSizeOptions"
          [canChangePageSize]="!!pageSizeOptions"
          (pageSizeChange)="
            onPageSizeValueChange($event)
          "></bia-table-footer-controller>
      </ng-template>
      <!-- EMPTY MESSAGE -->
      <ng-template pTemplate="emptymessage" let-columns>
        <tr>
          <td
            class="app-empty-message"
            [attr.colspan]="columns.length + (showFixableState ? 2 : 1)">
            {{ 'bia.NoRecordsFound' | translate }}
          </td>
        </tr>
      </ng-template>
    </p-table>
  </form>
}
